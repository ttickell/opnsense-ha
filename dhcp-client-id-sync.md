# DHCP Client Identifier Synchronization Guide

## Problem
Comcast cable modems bind DHCP leases to both MAC address AND DHCP Client Identifier (Option 61). 
Virtual firewalls may generate different client identifiers than physical hardware, causing lease failures.

## Solution: Force Identical Client Identifiers

### Method 1: OPNsense GUI Configuration
1. **On Physical Firewall (Primary):**
   - Go to `Interfaces â†’ [WAN Interface]` 
   - Scroll to DHCP client configuration
   - Note any existing "Client Identifier" value
   - If empty, the system generates one automatically

2. **Capture Current Client ID:**
   ```bash
   # On working physical firewall, check current DHCP lease
   cat /var/db/dhclient.leases.wan
   # Look for "send dhcp-client-identifier" line
   
   # Alternative: Check active DHCP process
   ps aux | grep dhclient
   cat /var/etc/dhclient_wan.conf
   ```

3. **Set Explicit Client ID on Both Firewalls:**
   - Use format: `01:xx:xx:xx:xx:xx:xx` (where xx:xx:xx:xx:xx:xx is your WAN MAC)
   - Or use a custom string like: `"opnsense-ha-cluster"`

### Method 2: Configuration File Override

Create persistent client identifier configuration:

```bash
# On both firewalls, create override file
cat > /usr/local/etc/dhclient_wan_override.conf << 'EOF'
# Force consistent DHCP client identifier for HA
send dhcp-client-identifier "opnsense-ha-wan-client";
# Alternative MAC-based format:
# send dhcp-client-identifier 01:aa:bb:cc:dd:ee:ff;
EOF

# Make it persistent across reboots
echo 'dhclient_wan_override_enable="YES"' >> /etc/rc.conf.local
```

### Method 3: rc.syshook Integration

Add client ID synchronization to your existing HA system:

```bash
# Add to your HA setup script
setup_dhcp_client_sync() {
    local CLIENT_ID="opnsense-ha-cluster"
    local WAN_INTERFACE="$1"
    
    log_info "Setting up DHCP client identifier sync for HA..."
    
    # Create dhclient override configuration
    cat > /usr/local/etc/dhclient_${WAN_INTERFACE}_override.conf << EOF
# DHCP Client Identifier for HA Consistency
# Generated by setup-firewall on $(date)
send dhcp-client-identifier "${CLIENT_ID}";

# Ensure consistent DHCP options
send host-name "$(hostname)";
request subnet-mask, broadcast-address, time-offset, routers,
        domain-name, domain-name-servers, domain-search, host-name,
        dhcp6.name-servers, dhcp6.domain-search, dhcp6.fqdn, dhcp6.sntp-servers,
        netbios-name-servers, netbios-scope, interface-mtu,
        rfc3442-classless-static-routes, ntp-servers;
EOF

    # Hook into OPNsense DHCP client startup
    local DHCP_HOOK="/usr/local/etc/rc.syshook.d/start/25-dhcp-client-id"
    cat > "${DHCP_HOOK}" << 'EOF'
#!/bin/sh
# DHCP Client ID override for HA consistency

WAN_IF="${1:-wan}"
OVERRIDE_CONF="/usr/local/etc/dhclient_${WAN_IF}_override.conf"

if [ -f "${OVERRIDE_CONF}" ]; then
    # Inject our override into dhclient configuration
    if [ -f "/var/etc/dhclient_${WAN_IF}.conf" ]; then
        # Backup original if not already done
        [ ! -f "/var/etc/dhclient_${WAN_IF}.conf.orig" ] && \
            cp "/var/etc/dhclient_${WAN_IF}.conf" "/var/etc/dhclient_${WAN_IF}.conf.orig"
        
        # Prepend our overrides
        cat "${OVERRIDE_CONF}" "/var/etc/dhclient_${WAN_IF}.conf.orig" > "/var/etc/dhclient_${WAN_IF}.conf"
        
        logger -t "dhcp-client-id" "Applied client identifier override for ${WAN_IF}"
    fi
fi
EOF
    
    chmod +x "${DHCP_HOOK}"
    log_success "DHCP client identifier synchronization configured"
}
```

## **2. MAC Address + Client ID Combo Approach**

For maximum compatibility, sync BOTH MAC address and client identifier:

```bash
# Set identical MAC on both systems
WAN_MAC="aa:bb:cc:dd:ee:ff"  # Use your original physical MAC

# On virtual firewall, override both:
ifconfig vtnet4 ether ${WAN_MAC}  # Set MAC
# Plus set client ID to: 01:${WAN_MAC} (hardware type 01 + MAC)
```

## **3. Testing and Verification**

```bash
# Test DHCP client ID configuration
dhclient -T -cf /var/etc/dhclient_wan.conf -lf /var/db/dhclient.leases.wan -pf /var/run/dhclient.wan.pid wan

# Verify client ID in DHCP packets
tcpdump -i wan -v -s 1500 '(port 67 or port 68)' | grep -A5 -B5 "Client-ID"

# Check lease file for client identifier
grep "send dhcp-client-identifier" /var/etc/dhclient_wan.conf
```

## **4. Integration with Your Existing HA System**

Since you already have DUID synchronization for DHCPv6, you can extend this pattern:

<function_calls>
<invoke name="read_file">
<parameter name="filePath">/Users/tickell/workspace/opnsense-ha/setup-firewall